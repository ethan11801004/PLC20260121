<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>PLC å ±è¡¨è§£æ - å¼·åŠ›ç›¸å®¹ç‰ˆ</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 15px; background-color: #f0f2f5; }
        .container { max-width: 100%; margin: auto; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .upload-section { border: 2px dashed #1890ff; padding: 20px; text-align: center; margin-bottom: 20px; background: #e6f7ff; cursor: pointer; }
        .table-wrapper { width: 100%; overflow-x: auto; margin-bottom: 30px; border: 1px solid #d9d9d9; background: white; }
        table { border-collapse: collapse; table-layout: auto; width: 100%; background: white; }
        th { 
            background-color: #001529; color: white; 
            padding: 5px 4px; font-size: 12px;
            max-width: 80px; word-break: break-all; 
            white-space: normal; line-height: 1.2;
            position: sticky; top: 0; z-index: 10;
            cursor: pointer; user-select: none;
        }
        th:hover { background-color: #1890ff; }
        th::after { content: ' â†•'; font-size: 10px; opacity: 0.3; }
        td { border: 1px solid #d9d9d9; padding: 4px 2px; font-size: 13px; text-align: center; white-space: nowrap; min-width: 45px; }
        td:nth-child(1), td:nth-child(2) { min-width: 60px; white-space: normal; }
        .file-header { display: flex; align-items: center; justify-content: space-between; margin-top: 15px; margin-bottom: 5px; }
        .file-title { background: #52c41a; color: white; padding: 5px 10px; border-radius: 4px; font-weight: bold; font-size: 14px; }
        .btn-group { display: flex; gap: 10px; }
        .btn-remove { background: #ff4d4f; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .btn-copy { background: #1890ff; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .btn-copy:hover { background: #40a9ff; }
        .total-row { background-color: #fffbe6 !important; font-weight: bold; color: #d46b08; }
        .ratio-row { background-color: #e6f7ff !important; font-weight: bold; color: #0050b3; }
        .highlight-red { background-color: #ff4d4f !important; color: white !important; }
        tr.data-row { cursor: grab; }
        .hint { font-size: 12px; color: #666; margin-bottom: 10px; }
        #manual-copy-area { margin-top: 20px; border-top: 20px solid #f0f2f5; padding-top: 20px; display: none; }
        #manual-copy-area h3 { color: #d46b08; font-size: 16px; margin-bottom: 5px; }
        #manual-copy-area p { color: #666; font-size: 13px; margin: 0 0 10px 0; }
        #generated-image { border: 5px solid #1890ff; max-width: 100%; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“Š PLC å ±è¡¨è§£æ (å¼·åŠ›ç›¸å®¹ç‰ˆ)</h2>
    <div class="hint">ğŸ’¡ <b>æ“ä½œèªªæ˜ï¼š</b> è‹¥æŒ‰éˆ•ç„¡æ³•ç›´æ¥è¤‡è£½ï¼Œç³»çµ±æœƒè‡ªå‹•ä¸‹è¼‰åœ–ç‰‡ï¼Œæˆ–é¡¯ç¤ºåœ¨ä¸‹æ–¹ä¾›æ‚¨å³éµè¤‡è£½ã€‚</div>
    <div class="upload-section" onclick="document.getElementById('upload-input').click()">
        <strong>ğŸ“ é»æ“Šé¸å– Excel æª”æ¡ˆåŒ¯å…¥</strong>
        <input type="file" id="upload-input" accept=".xls,.xlsx" multiple style="display:none">
    </div>
    <div id="table-container"></div>
    
    <div id="manual-copy-area">
        <h3>ğŸ‘‡ æ‚¨çš„åœ–è¡¨åœ–ç‰‡å·²ç”Ÿæˆï¼š</h3>
        <p>å› ç‚ºç€è¦½å™¨å®‰å…¨æ€§é™åˆ¶ï¼Œè«‹ç›´æ¥<b>ã€Œå°åœ–ç‰‡æŒ‰å³éµã€â†’ã€Œè¤‡è£½å½±åƒã€</b>ï¼Œç„¶å¾Œåˆ° PPT è²¼ä¸Šå³å¯ã€‚</p>
        <img id="generated-image" src="" alt="Generated Report Chart" />
    </div>
</div>

<script>
    // [è¨­å®šå€] æœªä¾†è‹¥æœ‰æ›´å¤šä¸æƒ³è¢«è¤‡è£½(æˆªåœ–)çš„æ¨™é¡Œï¼Œè«‹ç›´æ¥åŠ é€²é€™å€‹æ¸…å–®
    const ignoreKeywords = [
        'OEE', 'æ¨™æº–PPH', 'å¯¦éš›PPH', 'ç¸½æ•…éšœæ™‚é–“', 
        'ç¸½æ•…éšœæ¬¡æ•¸', 'å¹³å‡æ’é™¤æ™‚é–“', 'æ¯ç™¾æ¬¡æ•…éšœæ¬¡æ•¸', 'æ¨™æº–äººæ©Ÿæ¯”'
    ];

    let sortOrders = {};

    document.getElementById('upload-input').addEventListener('change', function(e) {
        const files = e.target.files;
        const container = document.getElementById('table-container');
        document.getElementById('manual-copy-area').style.display = 'none';
        
        container.innerHTML = '';
        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(event) {
                const content = event.target.result;
                let data = [];
                if (content.includes('<table') || content.includes('<tr')) {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(content, 'text/html');
                    const rows = doc.querySelectorAll('tr');
                    rows.forEach(row => {
                        const cells = Array.from(row.querySelectorAll('th, td')).map(td => td.innerText.trim());
                        if (cells.length > 0) data.push(cells);
                    });
                } else {
                    const workbook = XLSX.read(content, { type: 'binary' });
                    data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 });
                }
                if (data.length > 0) renderTable(file.name, data);
            };
            reader.readAsText(file);
        });
    });

    function renderTable(fileName, data) {
        const container = document.getElementById('table-container');
        const tableId = 'table-' + Math.random().toString(36).substr(2, 9);
        const wrapperId = 'wrapper-' + tableId;

        let machineIdx = -1;
        let defectIdx = -1;
        const headers = data[0];
        
        headers.forEach((h, idx) => {
            if (h.includes('æ©Ÿå°')) machineIdx = idx;
            if (h.includes('ä¸è‰¯å“æ•¸') || h.includes('ç¸½ä¸è‰¯æ•¸')) defectIdx = idx;
        });

        let html = `
            <div class="file-header">
                <div class="file-title">ğŸ“„ ${fileName}</div>
                <div class="btn-group">
                    <button class="btn-copy" onclick="processChartImage('${wrapperId}', '${fileName}')">ğŸ“· ç”¢ç”Ÿåœ–è¡¨ / è¤‡è£½</button>
                    <button class="btn-remove" onclick="removeSelected('${tableId}')">ğŸ—‘ ç§»é™¤é¸å–</button>
                </div>
            </div>
            <div class="table-wrapper" id="${wrapperId}">
                <table id="full-${tableId}">
                    <thead>
                        <tr>
                            <th style="width:30px;" data-html2canvas-ignore>ç‹€æ…‹</th>
                            ${headers.map((h, idx) => {
                                // åˆ¤æ–·æ˜¯å¦åœ¨æ’é™¤æ¸…å–®ä¸­
                                const shouldIgnore = ignoreKeywords.some(key => (h || '').includes(key));
                                const ignoreAttr = shouldIgnore ? ' data-html2canvas-ignore' : '';
                                return `<th${ignoreAttr} ondblclick="sortTable('${tableId}', ${idx + 1})">${h || ''}</th>`;
                            }).join('')}
                        </tr>
                    </thead>
                    <tbody id="${tableId}">`;

        for (let i = 1; i < data.length; i++) {
            const rowData = data[i];
            if (rowData.length === 0 || !rowData.join('') || rowData[0] === headers[0]) continue;
            
            let shouldSkip = false;
            if (machineIdx !== -1 && rowData[machineIdx] && rowData[machineIdx].includes('å¤–è§€')) shouldSkip = true;
            if (defectIdx !== -1) {
                let defectVal = parseFloat(rowData[defectIdx].toString().replace(/,/g, ''));
                if (defectVal === 0 || isNaN(defectVal)) shouldSkip = true;
            }
            if (shouldSkip) continue;

            html += `<tr class="data-row">
                <td data-html2canvas-ignore><input type="checkbox" class="row-check"></td>
                ${rowData.map((cell, idx) => {
                    // æ ¹æ“šç•¶å‰æ¬„ä½çš„æ¨™é¡Œåˆ¤æ–·æ˜¯å¦éœ€åœ¨æˆªåœ–ä¸­éš±è—
                    const hName = headers[idx] || '';
                    const shouldIgnore = ignoreKeywords.some(key => hName.includes(key));
                    const ignoreAttr = shouldIgnore ? ' data-html2canvas-ignore' : '';
                    return `<td${ignoreAttr} ondblclick="toggleHighlight(this)">${cell || ''}</td>`;
                }).join('')}
            </tr>`;
        }
        
        html += `</tbody><tfoot id="foot-${tableId}"></tfoot></table></div>`;
        container.insertAdjacentHTML('beforeend', html);
        updateCalculations(tableId);
        Sortable.create(document.getElementById(tableId), { animation: 150 });
    }

    async function processChartImage(elementId, fileName) {
        const element = document.getElementById(elementId);
        if (!element) return;

        const originalBtn = document.querySelector(`button[onclick="processChartImage('${elementId}', '${fileName}')"]`);
        const originalText = originalBtn.innerText;
        originalBtn.innerText = "â³ è™•ç†ä¸­...";
        originalBtn.disabled = true;

        try {
            const canvas = await html2canvas(element, {
                scale: 1,
                backgroundColor: "#ffffff",
                useCORS: true
            });

            canvas.toBlob(async (blob) => {
                try {
                    await navigator.clipboard.write([
                        new ClipboardItem({ 'image/png': blob })
                    ]);
                    alert('âœ… æˆåŠŸï¼åœ–è¡¨å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ã€‚');
                } catch (err) {
                    handleFallback(canvas, fileName);
                }
                originalBtn.innerText = originalText;
                originalBtn.disabled = false;
            });
        } catch (error) {
            console.error('æˆªåœ–éŒ¯èª¤:', error);
            alert('âŒ ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢å†è©¦');
            originalBtn.innerText = originalText;
            originalBtn.disabled = false;
        }
    }

    function handleFallback(canvas, fileName) {
        const imgData = canvas.toDataURL("image/png");
        const link = document.createElement('a');
        link.download = `PLCå ±è¡¨_${fileName}.png`;
        link.href = imgData;
        link.click();

        const manualArea = document.getElementById('manual-copy-area');
        const imgTag = document.getElementById('generated-image');
        imgTag.src = imgData;
        manualArea.style.display = 'block';
        manualArea.scrollIntoView({ behavior: 'smooth' });
        alert('âš ï¸ æ³¨æ„ï¼šç”±æ–¼ç€è¦½å™¨å®‰å…¨æ€§é™åˆ¶ï¼ˆæœ¬åœ°æª”æ¡ˆï¼‰ï¼Œç„¡æ³•è‡ªå‹•è¤‡è£½ã€‚\n\nâœ… å·²ç‚ºæ‚¨è‡ªå‹•ä¸‹è¼‰åœ–ç‰‡ï¼\nğŸ‘‡ æˆ–è€…æ‚¨ä¹Ÿå¯ä»¥åœ¨ä¸‹æ–¹é¡¯ç¤ºçš„åœ–ç‰‡ä¸ŠæŒ‰ã€Œå³éµ -> è¤‡è£½å½±åƒã€ã€‚');
    }

    window.sortTable = function(tableId, colIndex) {
        const tbody = document.getElementById(tableId);
        const rows = Array.from(tbody.querySelectorAll('tr.data-row'));
        const orderKey = `${tableId}-${colIndex}`;
        sortOrders[orderKey] = sortOrders[orderKey] === 'desc' ? 'asc' : 'desc';
        const isDesc = sortOrders[orderKey] === 'desc';

        rows.sort((a, b) => {
            let valA = a.cells[colIndex].innerText.replace(/,/g, '');
            let valB = b.cells[colIndex].innerText.replace(/,/g, '');
            let numA = parseFloat(valA), numB = parseFloat(valB);
            if (!isNaN(numA) && !isNaN(numB)) return isDesc ? numB - numA : numA - numB;
            return isDesc ? valB.localeCompare(valA, 'zh-Hant') : valA.localeCompare(valB, 'zh-Hant');
        });
        rows.forEach(row => tbody.appendChild(row));
    };

    function removeSelected(tableId) {
        const tbody = document.getElementById(tableId);
        const checks = tbody.querySelectorAll('.row-check:checked');
        if (checks.length === 0) return;
        if (confirm('ç¢ºå®šç§»é™¤é¸ä¸­é …ç›®ï¼Ÿ')) {
            checks.forEach(chk => chk.closest('tr').remove());
            updateCalculations(tableId);
        }
    }

    function updateCalculations(tableId) {
        const tbody = document.getElementById(tableId);
        const tfoot = document.getElementById('foot-' + tableId);
        const rows = tbody.querySelectorAll('tr.data-row');
        const headers = document.querySelectorAll(`#full-${tableId} th`);
        const colCount = headers.length;
        let totals = new Array(colCount).fill(0);
        let hasNumber = new Array(colCount).fill(false);
        let isCalculatable = new Array(colCount).fill(true);
        let productionIdx = -1;

        headers.forEach((th, idx) => {
            const title = th.innerText;
            if (title.includes('ç”Ÿç”¢æ•¸')) productionIdx = idx;
            const blacklist = ['çµ„åˆ¥', 'ä»£è™Ÿ', 'ID', 'ç‡', '%', 'æ–™è™Ÿ', 'äººæ©Ÿæ¯”', 'æ¨™æº–å·¥', 'å·¥æ™‚', 'PPH', 'æ™‚é–“', 'æ¬¡æ•¸'];
            if (blacklist.some(key => title.includes(key))) isCalculatable[idx] = false;
        });

        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            cells.forEach((td, idx) => {
                if (idx > 0 && isCalculatable[idx]) {
                    let val = td.innerText.replace(/,/g, '');
                    if (!isNaN(val) && val !== '') {
                        totals[idx] += parseFloat(val);
                        hasNumber[idx] = true;
                    }
                }
            });
        });

        const prodTotal = productionIdx !== -1 ? totals[productionIdx] : 0;
        
        let footHtml = `<tr class="total-row"><td data-html2canvas-ignore>-</td><td>åˆè¨ˆ</td>`;
        for (let j = 2; j < colCount; j++) {
            // åˆè¨ˆåˆ—ä¹Ÿæ ¹æ“šæ¨™é¡Œé—œéµå­—æ±ºå®šæ˜¯å¦æ’é™¤
            const hName = headers[j].innerText;
            const shouldIgnore = ignoreKeywords.some(key => hName.includes(key));
            const ignoreAttr = shouldIgnore ? ' data-html2canvas-ignore' : '';

            let val = (isCalculatable[j] && hasNumber[j]) ? Math.round(totals[j] * 100) / 100 : "";
            footHtml += `<td${ignoreAttr} ondblclick="toggleHighlight(this)">${val}</td>`;
        }
        
        footHtml += `</tr><tr class="ratio-row"><td data-html2canvas-ignore>-</td><td>æ¯”ç‡</td>`;
        for (let j = 2; j < colCount; j++) {
            // æ¯”ç‡åˆ—åŒæ¨£åŸ·è¡Œæ’é™¤åˆ¤æ–·
            const hName = headers[j].innerText;
            const shouldIgnore = ignoreKeywords.some(key => hName.includes(key));
            const ignoreAttr = shouldIgnore ? ' data-html2canvas-ignore' : '';

            let ratio = (j !== productionIdx && isCalculatable[j] && hasNumber[j] && prodTotal > 0) 
                        ? ((totals[j] / prodTotal) * 100).toFixed(2) + "%" : "";
            footHtml += `<td${ignoreAttr} ondblclick="toggleHighlight(this)">${ratio}</td>`;
        }
        tfoot.innerHTML = footHtml + `</tr>`;
    }

    function toggleHighlight(element) { element.classList.toggle('highlight-red'); }
</script>

</body>
</html>